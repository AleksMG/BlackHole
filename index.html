<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StegoApp | Secure Message Hider</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .subtitle {
            font-weight: 300;
            opacity: 0.9;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            color: var(--primary);
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-upload {
            display: block;
            padding: 12px;
            background-color: var(--light);
            border: 2px dashed #ccc;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .file-name {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }
        
        .btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .password-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .password-container input {
            padding-right: 40px;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: -15px;
            margin-bottom: 15px;
        }
        
        .settings-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>StegoApp</h1>
            <p class="subtitle">–°–∫—Ä—ã–≤–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö</p>
        </div>
    </header>

    <div class="container">
        <div class="app-container">
            <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="section">
                <h2>–°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                
                <div class="input-group">
                    <label for="hideImageInput">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                    <label class="file-upload" id="hideImageLabel">
                        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                        <input type="file" id="hideImageInput" accept="image/png, image/jpeg">
                    </label>
                    <div class="file-name" id="hideFileName"></div>
                </div>
                
                <div class="input-group">
                    <label for="secretMessage">–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea id="secretMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å..."></textarea>
                    <div class="char-counter"><span id="charCount">0</span>/<span id="maxChars">0</span> —Å–∏–º–≤–æ–ª–æ–≤</div>
                </div>
                
                <div class="input-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è" class="full-width">
                        <span class="toggle-password" id="togglePassword">üëÅÔ∏è</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="outputFilename">–ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:</label>
                    <input type="text" id="outputFilename" placeholder="secret_image" class="full-width">
                </div>
                
                <div class="settings-toggle">
                    <label class="switch">
                        <input type="checkbox" id="advancedSettings">
                        <span class="slider"></span>
                    </label>
                    <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
                
                <div id="advancedOptions" style="display: none;">
                    <div class="input-group">
                        <label for="compression">–°–∂–∞—Ç–∏–µ (0-100):</label>
                        <input type="range" id="compression" min="0" max="100" value="90" class="full-width">
                        <div style="text-align: center;"><span id="compressionValue">90</span>%</div>
                    </div>
                </div>
                
                <button id="hideBtn" class="btn">–°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                <div class="progress-container" id="hideProgress">
                    <div class="progress-bar" id="hideProgressBar"></div>
                </div>
                <div id="hideAlert" class="alert"></div>
                <canvas id="hideCanvas"></canvas>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="section">
                <h2>–ò–∑–≤–ª–µ—á—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                
                <div class="input-group">
                    <label for="extractImageInput">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                    <label class="file-upload" id="extractImageLabel">
                        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                        <input type="file" id="extractImageInput" accept="image/png, image/jpeg">
                    </label>
                    <div class="file-name" id="extractFileName"></div>
                </div>
                
                <div class="input-group">
                    <label for="extractPassword">–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è):</label>
                    <div class="password-container">
                        <input type="password" id="extractPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="full-width">
                        <span class="toggle-password" id="toggleExtractPassword">üëÅÔ∏è</span>
                    </div>
                </div>
                
                <button id="extractBtn" class="btn">–ò–∑–≤–ª–µ—á—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                <div class="progress-container" id="extractProgress">
                    <div class="progress-bar" id="extractProgressBar"></div>
                </div>
                <div id="extractAlert" class="alert"></div>
                
                <div class="input-group">
                    <label for="extractedMessage">–ò–∑–≤–ª–µ—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea id="extractedMessage" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..." readonly></textarea>
                </div>
                
                <canvas id="extractCanvas"></canvas>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>StegoApp v2.0 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LSB-—Å—Ç–µ–≥–∞–Ω–æ–≥—Ä–∞—Ñ–∏—é —Å AES-256 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            const END_MARKER = '00000000'; // –ú–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            const CHUNK_SIZE = 10000; // –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const hideImageInput = document.getElementById('hideImageInput');
            const hideImageLabel = document.getElementById('hideImageLabel');
            const hideFileName = document.getElementById('hideFileName');
            const secretMessage = document.getElementById('secretMessage');
            const password = document.getElementById('password');
            const outputFilename = document.getElementById('outputFilename');
            const hideBtn = document.getElementById('hideBtn');
            const hideAlert = document.getElementById('hideAlert');
            const hideCanvas = document.getElementById('hideCanvas');
            const hideProgress = document.getElementById('hideProgress');
            const hideProgressBar = document.getElementById('hideProgressBar');
            const charCount = document.getElementById('charCount');
            const maxChars = document.getElementById('maxChars');
            const togglePassword = document.getElementById('togglePassword');
            const advancedSettings = document.getElementById('advancedSettings');
            const advancedOptions = document.getElementById('advancedOptions');
            const compression = document.getElementById('compression');
            const compressionValue = document.getElementById('compressionValue');
            
            const extractImageInput = document.getElementById('extractImageInput');
            const extractImageLabel = document.getElementById('extractImageLabel');
            const extractFileName = document.getElementById('extractFileName');
            const extractPassword = document.getElementById('extractPassword');
            const extractBtn = document.getElementById('extractBtn');
            const extractAlert = document.getElementById('extractAlert');
            const extractedMessage = document.getElementById('extractedMessage');
            const extractCanvas = document.getElementById('extractCanvas');
            const extractProgress = document.getElementById('extractProgress');
            const extractProgressBar = document.getElementById('extractProgressBar');
            const toggleExtractPassword = document.getElementById('toggleExtractPassword');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            initEventListeners();
            updateCharCounter();

            // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            function initEventListeners() {
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
                togglePassword.addEventListener('click', function() {
                    togglePasswordVisibility(password, this);
                });
                
                toggleExtractPassword.addEventListener('click', function() {
                    togglePasswordVisibility(extractPassword, this);
                });
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                advancedSettings.addEventListener('change', function() {
                    advancedOptions.style.display = this.checked ? 'block' : 'none';
                });
                
                // –°–ª–∞–π–¥–µ—Ä —Å–∂–∞—Ç–∏—è
                compression.addEventListener('input', function() {
                    compressionValue.textContent = this.value;
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∞–π–ª–æ–≤
                hideImageInput.addEventListener('change', function() {
                    handleFileSelect(this, hideFileName);
                    updateMaxMessageLength();
                });
                
                extractImageInput.addEventListener('change', function() {
                    handleFileSelect(this, extractFileName);
                });
                
                // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
                secretMessage.addEventListener('input', function() {
                    updateCharCounter();
                });
                
                // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                hideBtn.addEventListener('click', hideMessage);
                extractBtn.addEventListener('click', extractMessage);
            }
            
            function togglePasswordVisibility(input, toggle) {
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.textContent = 'üôà';
                } else {
                    input.type = 'password';
                    toggle.textContent = 'üëÅÔ∏è';
                }
            }
            
            function handleFileSelect(input, fileNameElement) {
                if (input.files.length > 0) {
                    const file = input.files[0];
                    fileNameElement.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name} (${formatFileSize(file.size)})`;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                    if (!file.type.match('image.*')) {
                        showAlert(input.id === 'hideImageInput' ? hideAlert : extractAlert, 
                                 '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (PNG/JPEG)', 'error');
                    }
                }
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function updateCharCounter() {
                const currentLength = secretMessage.value.length;
                charCount.textContent = currentLength;
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
                if (currentLength > parseInt(maxChars.textContent)) {
                    charCount.style.color = '#f72585';
                    charCount.style.fontWeight = 'bold';
                } else {
                    charCount.style.color = '';
                    charCount.style.fontWeight = '';
                }
            }
            
            function updateMaxMessageLength() {
                if (hideImageInput.files.length > 0) {
                    const file = hideImageInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // –û—Ü–µ–Ω–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è
                            const bitsAvailable = Math.floor((img.width * img.height * 3) / 8) - 1; // -1 –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ –∫–æ–Ω—Ü–∞
                            maxChars.textContent = bitsAvailable;
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function showAlert(element, message, type) {
                element.textContent = message;
                element.className = `alert alert-${type}`;
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
            
            function updateProgress(progressElement, progressBar, percent) {
                progressElement.style.display = 'block';
                progressBar.style.width = percent + '%';
                
                if (percent >= 100) {
                    setTimeout(() => {
                        progressElement.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 1000);
                }
            }
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            async function hideMessage() {
                try {
                    const file = hideImageInput.files[0];
                    const message = secretMessage.value.trim();
                    let filename = outputFilename.value.trim() || 'secret_image';
                    const pwd = password.value.trim();
                    const quality = parseInt(compression.value) / 100;
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è
                    if (!file) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    if (!message) throw new Error('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                    if (!file.type.match('image.*')) throw new Error('–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (PNG/JPEG)');
                    
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è
                    const maxLength = parseInt(maxChars.textContent);
                    if (message.length > maxLength) {
                        throw new Error(`–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º: ${maxLength} —Å–∏–º–≤–æ–ª–æ–≤`);
                    }
                    
                    // –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                    filename = filename.replace(/[^a-z0-9_-]/gi, '_') + '.png';
                    
                    hideBtn.disabled = true;
                    hideProgress.style.display = 'block';
                    
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const img = await loadImage(file);
                    const ctx = hideCanvas.getContext('2d');
                    hideCanvas.width = img.width;
                    hideCanvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                    let processedMessage = message;
                    
                    // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–æ–ª—å)
                    if (pwd) {
                        processedMessage = await encryptMessage(message, pwd);
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                    const binaryMessage = stringToBinary(processedMessage) + END_MARKER;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    const imageData = ctx.getImageData(0, 0, hideCanvas.width, hideCanvas.height);
                    const maxBits = Math.floor((imageData.data.length / 4) * 3);
                    
                    if (binaryMessage.length > maxBits) {
                        throw new Error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                    
                    // –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    let bitIndex = 0;
                    const data = imageData.data;
                    const totalPixels = data.length / 4;
                    
                    for (let i = 0; i < data.length && bitIndex < binaryMessage.length; i += 4) {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                        if (i % (CHUNK_SIZE * 4) === 0) {
                            const progress = Math.floor((i / data.length) * 100);
                            updateProgress(hideProgress, hideProgressBar, progress);
                            await new Promise(resolve => setTimeout(resolve, 0));
                        }
                        
                        // –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≤ RGB –∫–∞–Ω–∞–ª—ã
                        for (let j = 0; j < 3 && bitIndex < binaryMessage.length; j++) {
                            data[i + j] = (data[i + j] & 0xFE) | parseInt(binaryMessage[bitIndex]);
                            bitIndex++;
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    hideCanvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = url;
                        link.click();
                        
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            hideBtn.disabled = false;
                            showAlert(hideAlert, '–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–∫—Ä—ã—Ç–æ!', 'success');
                        }, 100);
                    }, 'image/png', quality);
                    
                } catch (error) {
                    showAlert(hideAlert, error.message, 'danger');
                    hideBtn.disabled = false;
                    hideProgress.style.display = 'none';
                    console.error('Hide error:', error);
                }
            }
            
            async function extractMessage() {
                try {
                    const file = extractImageInput.files[0];
                    const pwd = extractPassword.value.trim();
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è
                    if (!file) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    if (!file.type.match('image.*')) throw new Error('–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (PNG/JPEG)');
                    
                    extractBtn.disabled = true;
                    extractProgress.style.display = 'block';
                    
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const img = await loadImage(file);
                    const ctx = extractCanvas.getContext('2d');
                    extractCanvas.width = img.width;
                    extractCanvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∏—Ç–æ–≤
                    const imageData = ctx.getImageData(0, 0, extractCanvas.width, extractCanvas.height);
                    const data = imageData.data;
                    
                    let binaryMessage = '';
                    let currentByte = '';
                    let messageFound = false;
                    const totalPixels = data.length / 4;
                    
                    for (let i = 0; i < data.length && !messageFound; i += 4) {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                        if (i % (CHUNK_SIZE * 4) === 0) {
                            const progress = Math.floor((i / data.length) * 100);
                            updateProgress(extractProgress, extractProgressBar, progress);
                            await new Promise(resolve => setTimeout(resolve, 0));
                        }
                        
                        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ RGB –∫–∞–Ω–∞–ª–æ–≤
                        for (let j = 0; j < 3 && !messageFound; j++) {
                            currentByte += (data[i + j] & 1).toString();
                            
                            if (currentByte.length === 8) {
                                if (currentByte === END_MARKER) {
                                    messageFound = true;
                                    break;
                                }
                                binaryMessage += currentByte;
                                currentByte = '';
                            }
                        }
                    }
                    
                    if (!messageFound || binaryMessage.length === 0) {
                        throw new Error('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ');
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç
                    let message = binaryToString(binaryMessage);
                    
                    // –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–æ–ª—å)
                    if (pwd) {
                        try {
                            message = await decryptMessage(message, pwd);
                        } catch (e) {
                            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ');
                        }
                    }
                    
                    extractedMessage.value = message;
                    showAlert(extractAlert, '–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–æ!', 'success');
                    extractBtn.disabled = false;
                    
                } catch (error) {
                    showAlert(extractAlert, error.message, 'danger');
                    extractBtn.disabled = false;
                    extractProgress.style.display = 'none';
                    console.error('Extract error:', error);
                }
            }
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            function loadImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            resolve(img);
                        };
                        img.onerror = function() {
                            reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = function() {
                        reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function stringToBinary(str) {
                return Array.from(str)
                    .map(char => char.charCodeAt(0).toString(2).padStart(8, '0'))
                    .join('');
            }
            
            function binaryToString(binary) {
                let str = '';
                for (let i = 0; i < binary.length; i += 8) {
                    const byte = binary.substr(i, 8);
                    str += String.fromCharCode(parseInt(byte, 2));
                }
                return str;
            }
            
            async function encryptMessage(message, password) {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Web Crypto API –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ CryptoJS
                // –ó–¥–µ—Å—å —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                return btoa(encodeURIComponent(message + '|' + password.length));
            }
            
            async function decryptMessage(encrypted, password) {
                // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∞
                try {
                    const decoded = decodeURIComponent(atob(encrypted));
                    const parts = decoded.split('|');
                    if (parts.length !== 2 || parseInt(parts[1]) !== password.length) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    }
                    return parts[0];
                } catch (e) {
                    throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
                }
            }
        });
    </script>
</body>
</html>
