<!DOCTYPE html>
<html>
<head>
    <title>Стеганография: скрытие бинарного кода в изображении</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { border: 1px solid #000; margin: 10px 0; max-width: 500px; }
        .container { display: flex; gap: 20px; }
        .column { flex: 1; }
        button { margin: 5px 0; padding: 8px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        textarea { width: 100%; height: 80px; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Стеганография (LSB-метод)</h1>
    <div class="container">
        <div class="column">
            <h2>1. Скрыть сообщение в изображении</h2>
            <input type="file" id="originalImage" accept="image/png, image/jpeg"><br>
            <textarea id="secretMessage" placeholder="Введите секретное сообщение..."></textarea><br>
            <button onclick="hideMessage()">Спрятать сообщение</button>
            <canvas id="encodedCanvas"></canvas>
            <button onclick="downloadImage()" id="downloadBtn" disabled>Скачать изображение</button>
        </div>
        
        <div class="column">
            <h2>2. Извлечь сообщение из изображения</h2>
            <input type="file" id="encodedImage" accept="image/png, image/jpeg"><br>
            <button onclick="extractMessage()">Извлечь сообщение</button>
            <p id="extractedMessage"></p>
            <canvas id="decodedCanvas"></canvas>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let encodedImageData = null;

        // 1. Скрытие сообщения в изображении (LSB-метод)
        function hideMessage() {
            const fileInput = document.getElementById('originalImage');
            const message = document.getElementById('secretMessage').value;
            
            if (!fileInput.files[0] || !message) {
                alert("Загрузите изображение и введите сообщение!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('encodedCanvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Преобразуем сообщение в бинарный формат
                    const binaryMessage = message.split('')
                        .map(char => char.charCodeAt(0).toString(2).padStart(8, '0'))
                        .join('') + '00000000'; // Маркер конца сообщения
                    
                    // Получаем данные изображения
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Проверяем, поместится ли сообщение
                    if (binaryMessage.length > data.length * 0.25) {
                        alert("Сообщение слишком длинное для этого изображения!");
                        return;
                    }
                    
                    // Встраиваем сообщение в LSB (младшие биты)
                    let messageIndex = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        if (messageIndex >= binaryMessage.length) break;
                        
                        // Модифицируем LSB каждого цветового канала (R, G, B)
                        for (let j = 0; j < 3; j++) {
                            if (messageIndex < binaryMessage.length) {
                                data[i + j] = (data[i + j] & 0xFE) | parseInt(binaryMessage[messageIndex]);
                                messageIndex++;
                            }
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    encodedImageData = canvas.toDataURL('image/png');
                    document.getElementById('downloadBtn').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        // 2. Извлечение сообщения из изображения
        function extractMessage() {
            const fileInput = document.getElementById('encodedImage');
            if (!fileInput.files[0]) {
                alert("Загрузите изображение!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('decodedCanvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Извлекаем биты из LSB
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    let binaryMessage = '';
                    let message = '';
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // Читаем LSB каждого цветового канала
                        for (let j = 0; j < 3; j++) {
                            binaryMessage += (data[i + j] & 1).toString();
                            
                            // Проверяем на маркер конца сообщения (8 нулей)
                            if (binaryMessage.length % 8 === 0) {
                                const byte = binaryMessage.substr(-8);
                                if (byte === '00000000') {
                                    // Преобразуем бинарную строку в текст
                                    for (let k = 0; k < binaryMessage.length - 8; k += 8) {
                                        const charCode = parseInt(binaryMessage.substr(k, 8), 2);
                                        message += String.fromCharCode(charCode);
                                    }
                                    document.getElementById('extractedMessage').textContent = message;
                                    return;
                                }
                            }
                        }
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        // 3. Скачивание изображения со скрытым сообщением
        function downloadImage() {
            if (!encodedImageData) return;
            
            const link = document.createElement('a');
            link.download = 'secret_image.png';
            link.href = encodedImageData;
            link.click();
        }
    </script>
</body>
</html>
